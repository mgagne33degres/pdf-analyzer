<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de PDF avec Claude</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            background-color: #f9f9f9;
        }
        #pdfPreview {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            background-color: white;
        }
        #results {
            white-space: pre-wrap;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            min-height: 200px;
        }
        .page-break {
            page-break-after: always;
            border-bottom: 1px dashed #ccc;
            margin: 20px 0;
        }
        h1, h2 {
            color: #333;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input[type="file"] {
            margin-bottom: 10px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: inherit;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 10px 0;
        }
        .progress {
            height: 20px;
            background-color: #4CAF50;
            border-radius: 4px;
            width: 0%;
            text-align: center;
            line-height: 20px;
            color: white;
        }
        .page-thumbnail {
            max-width: 200px;
            border: 1px solid #ddd;
            margin: 5px;
            cursor: pointer;
        }
        .page-thumbnail:hover {
            border-color: #4CAF50;
        }
        .settings {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .toggle-btn {
            background-color: #2196F3;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Analyseur de PDF avec Claude</h1>
        
        <div class="panel">
            <h2>1. Sélectionner un PDF</h2>
            <input type="file" id="pdfUpload" accept="application/pdf">
            <div id="pdfInfo"></div>
            <button id="toggleSettings" class="toggle-btn">Afficher les paramètres avancés</button>
            <div id="settings" class="settings" style="display: none;">
                <h3>Paramètres de conversion</h3>
                <div>
                    <label for="imageQuality">Qualité d'image (1-100): </label>
                    <input type="range" id="imageQuality" min="1" max="100" value="50">
                    <span id="qualityValue">50</span>
                </div>
                <div>
                    <label for="imageScale">Échelle de l'image (0.1-2.0): </label>
                    <input type="range" id="imageScale" min="0.1" max="2.0" step="0.1" value="0.5">
                    <span id="scaleValue">0.5</span>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>2. Critères d'analyse (modifiables)</h2>
            <textarea id="analysisCriteria" rows="12">Analyse du PDF en indiquant les numéros de pages concernées pour : 
- Nom du fichier analysé
- Erreurs orthographiques/typographiques 
- Incohérence des vues 
- Est-ce que nous oublions des vues, est-ce que l'on comprend bien le projet ?
- Incohérence des dimensions
- Vérifier le total lorsqu'il y a plusieurs dimensions au même niveau
- Informations techniques manquantes 
- Notes/spécifications
- Comparer les dimensions en considérant tous les éléments d'assemblage
- Vérifier les relations entre les différentes vues avant de signaler une incohérence</textarea>
        </div>
        
        <div class="panel">
            <h2>3. Clé API Claude</h2>
            <input type="password" id="apiKey" placeholder="Votre clé API Claude (commence par sk-ant-)" style="width: 100%; padding: 10px;">
            <!-- Remplacez la valeur ci-dessous par votre clé API -->
            <button id="setDefaultKey" style="margin-top: 10px;">Utiliser ma clé par défaut</button>
        </div>
        
        <div class="panel">
            <h2>4. Aperçu des pages</h2>
            <div id="pdfPreview">
                <p>Aperçu des pages s'affichera ici...</p>
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress" id="progress">0%</div>
            </div>
        </div>
        
        <button id="analyzeButton" disabled>Analyser le PDF</button>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Analyse en cours... Cela peut prendre quelques instants.</p>
        </div>
        
        <div class="panel">
            <h2>5. Résultats de l'analyse</h2>
            <div id="results">Les résultats s'afficheront ici...</div>
        </div>
    </div>

    <script>
        // Initialiser PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // Éléments DOM
        const pdfUpload = document.getElementById('pdfUpload');
        const pdfInfo = document.getElementById('pdfInfo');
        const pdfPreview = document.getElementById('pdfPreview');
        const analysisCriteria = document.getElementById('analysisCriteria');
        const apiKey = document.getElementById('apiKey');
        const analyzeButton = document.getElementById('analyzeButton');
        const results = document.getElementById('results');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const setDefaultKey = document.getElementById('setDefaultKey');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const imageQuality = document.getElementById('imageQuality');
        const imageScale = document.getElementById('imageScale');
        const qualityValue = document.getElementById('qualityValue');
        const scaleValue = document.getElementById('scaleValue');
        const toggleSettings = document.getElementById('toggleSettings');
        const settings = document.getElementById('settings');
        
        // Variables globales
        let pdfPages = [];
        let pdfName = "";
        
        // Remplacez par votre clé API Claude
        const DEFAULT_API_KEY = "sk-ant-VOTRE_CLE_API_ICI";
        
        // Montrer/cacher les paramètres avancés
        toggleSettings.addEventListener('click', function() {
            if (settings.style.display === 'none') {
                settings.style.display = 'block';
                toggleSettings.textContent = 'Masquer les paramètres avancés';
            } else {
                settings.style.display = 'none';
                toggleSettings.textContent = 'Afficher les paramètres avancés';
            }
        });
        
        // Mise à jour des valeurs affichées des sliders
        imageQuality.addEventListener('input', function() {
            qualityValue.textContent = this.value;
        });
        
        imageScale.addEventListener('input', function() {
            scaleValue.textContent = this.value;
        });
        
        // Utiliser la clé par défaut
        setDefaultKey.addEventListener('click', function() {
            apiKey.value = DEFAULT_API_KEY;
            checkFormValidity();
        });
        
        // Écouteur d'événement pour l'upload de PDF
        pdfUpload.addEventListener('change', async function(e) {
            if (!e.target.files.length) return;
            
            const file = e.target.files[0];
            pdfName = file.name;
            pdfInfo.textContent = `Fichier sélectionné: ${file.name} (${formatFileSize(file.size)})`;
            
            pdfPages = [];
            pdfPreview.innerHTML = '<p>Chargement du PDF...</p>';
            progressBar.style.display = 'block';
            
            const fileReader = new FileReader();
            fileReader.onload = async function() {
                const typedArray = new Uint8Array(this.result);
                try {
                    const pdf = await pdfjsLib.getDocument(typedArray).promise;
                    const totalPages = pdf.numPages;
                    
                    pdfPreview.innerHTML = '';
                    
                    // Créer une grille pour les miniatures
                    const thumbnailGrid = document.createElement('div');
                    thumbnailGrid.style.display = 'flex';
                    thumbnailGrid.style.flexWrap = 'wrap';
                    pdfPreview.appendChild(thumbnailGrid);
                    
                    // Pour chaque page du PDF
                    for (let i = 1; i <= totalPages; i++) {
                        // Mettre à jour la barre de progression
                        progress.style.width = `${Math.round((i - 1) / totalPages * 100)}%`;
                        progress.textContent = `${Math.round((i - 1) / totalPages * 100)}%`;
                        
                        const page = await pdf.getPage(i);
                        const scale = parseFloat(imageScale.value); // Échelle réduite
                        const viewport = page.getViewport({ scale });
                        
                        // Créer un canvas pour le rendu de la page
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        // Rendre la page sur le canvas
                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                        
                        // Convertir le canvas en base64 (JPG compressé)
                        const quality = parseInt(imageQuality.value) / 100;
                        const pageImage = canvas.toDataURL('image/jpeg', quality);
                        
                        // Ajouter à notre liste de pages
                        pdfPages.push({ 
                            pageNum: i,
                            image: pageImage
                        });
                        
                        // Créer une miniature pour l'aperçu
                        const thumbnail = document.createElement('img');
                        thumbnail.src = pageImage;
                        thumbnail.className = 'page-thumbnail';
                        thumbnail.title = `Page ${i}`;
                        thumbnail.alt = `Miniature page ${i}`;
                        thumbnail.onclick = function() {
                            // Permettre de cliquer pour agrandir (optionnel)
                            const fullImage = document.createElement('img');
                            fullImage.src = pageImage;
                            fullImage.style.maxWidth = '100%';
                            
                            const modalDiv = document.createElement('div');
                            modalDiv.style.position = 'fixed';
                            modalDiv.style.top = '0';
                            modalDiv.style.left = '0';
                            modalDiv.style.width = '100%';
                            modalDiv.style.height = '100%';
                            modalDiv.style.backgroundColor = 'rgba(0,0,0,0.8)';
                            modalDiv.style.display = 'flex';
                            modalDiv.style.justifyContent = 'center';
                            modalDiv.style.alignItems = 'center';
                            modalDiv.style.zIndex = '1000';
                            modalDiv.appendChild(fullImage);
                            modalDiv.onclick = function() {
                                document.body.removeChild(modalDiv);
                            };
                            
                            document.body.appendChild(modalDiv);
                        };
                        
                        thumbnailGrid.appendChild(thumbnail);
                    }
                    
                    // Mettre à jour la barre de progression à 100%
                    progress.style.width = '100%';
                    progress.textContent = '100%';
                    
                    // Activer le bouton d'analyse
                    analyzeButton.disabled = false;
                    checkFormValidity();
                    
                } catch (error) {
                    console.error("Erreur lors du chargement du PDF:", error);
                    pdfPreview.innerHTML = `<p>Erreur lors du chargement du PDF: ${error.message}</p>`;
                    progressBar.style.display = 'none';
                }
            };
            
            fileReader.readAsArrayBuffer(file);
        });
        
        // Vérifier si le formulaire est valide
        function checkFormValidity() {
            if (pdfPages.length > 0 && apiKey.value.trim() !== '') {
                analyzeButton.disabled = false;
            } else {
                analyzeButton.disabled = true;
            }
        }
        
        // Écouteur pour le champ de clé API
        apiKey.addEventListener('input', checkFormValidity);
        
        // Fonction pour formater la taille du fichier
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // Diviser le tableau en morceaux de taille spécifiée
        function chunkArray(array, chunkSize) {
            const chunks = [];
            for (let i = 0; i < array.length; i += chunkSize) {
                chunks.push(array.slice(i, i + chunkSize));
            }
            return chunks;
        }
        
        // Écouteur pour le bouton d'analyse
        analyzeButton.addEventListener('click', async function() {
            if (pdfPages.length === 0) {
                alert("Veuillez d'abord charger un PDF.");
                return;
            }
            
            if (apiKey.value.trim() === '') {
                alert("Veuillez entrer votre clé API Claude.");
                return;
            }
            
            loadingIndicator.style.display = 'block';
            results.textContent = "Analyse en cours...";
            
            try {
                // Si beaucoup de pages, on les traite par lots pour éviter les erreurs
                // La limite de taille de fichier pour Claude est d'environ 10 Mo par requête
                const MAX_PAGES_PER_REQUEST = 5; // Ajuster selon la taille des images
                const pageChunks = chunkArray(pdfPages, MAX_PAGES_PER_REQUEST);
                
                let fullAnalysis = "";
                
                for (let i = 0; i < pageChunks.length; i++) {
                    const chunk = pageChunks[i];
                    const pageRange = `${chunk[0].pageNum}-${chunk[chunk.length-1].pageNum}`;
                    
                    results.textContent = `Analyse en cours... Lot ${i+1}/${pageChunks.length} (pages ${pageRange})`;
                    
                    const chunkResponse = await analyzePDFWithClaude(chunk, pdfName, i+1, pageChunks.length);
                    fullAnalysis += chunkResponse + "\n\n";
                }
                
                // Si analysé par lots, faire une synthèse finale
                if (pageChunks.length > 1) {
                    results.textContent = "Génération de la synthèse finale...";
                    const synthèse = await createFinalSynthesis(fullAnalysis, pdfName);
                    results.textContent = synthèse;
                } else {
                    results.textContent = fullAnalysis;
                }
                
            } catch (error) {
                console.error("Erreur lors de l'analyse:", error);
                results.textContent = `Erreur lors de l'analyse: ${error.message}`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        });
        
        // Fonction pour analyser le PDF avec Claude
        async function analyzePDFWithClaude(pages, fileName, batchNumber, totalBatches) {
            // Construire le message pour Claude avec uniquement les images
            const content = [];
            
            // Ajouter le texte d'introduction
            let introText;
            if (totalBatches > 1) {
                introText = `Je vais vous fournir un PDF nommé "${fileName}" (lot ${batchNumber}/${totalBatches}, pages ${pages[0].pageNum}-${pages[pages.length-1].pageNum}). Voici les critères d'analyse à appliquer:\n\n${analysisCriteria.value}\n\n`;
            } else {
                introText = `Je vais vous fournir un PDF nommé "${fileName}". Voici les critères d'analyse à appliquer:\n\n${analysisCriteria.value}\n\n`;
            }
            
            content.push({
                type: "text",
                text: introText
            });
            
            // Ajouter chaque page comme une image
            for (const page of pages) {
                content.push(
                    {
                        type: "image",
                        source: {
                            type: "base64",
                            media_type: "image/jpeg",
                            data: page.image.split(',')[1] // Enlever le préfixe "data:image/jpeg;base64,"
                        }
                    },
                    {
                        type: "text",
                        text: `---- PAGE ${page.pageNum} ----\n`
                    }
                );
            }
            
            // Ajouter un message final demandant l'analyse
            let finalText;
            if (totalBatches > 1) {
                finalText = `Veuillez analyser ces pages (${pages[0].pageNum}-${pages[pages.length-1].pageNum}) selon les critères fournis. Soyez précis en indiquant les numéros de page pour chaque observation. Comme il s'agit d'un lot partiel (${batchNumber}/${totalBatches}), concentrez-vous uniquement sur les problèmes visibles dans ces pages.`;
            } else {
                finalText = "Veuillez analyser ce document selon les critères fournis ci-dessus. Soyez précis en indiquant les numéros de page pour chaque observation.";
            }
            
            content.push({
                type: "text",
                text: finalText
            });
            
            // Appel à l'API Claude
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey.value.trim(),
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: "claude-3-opus-20240229",
                        max_tokens: 4000,
                        temperature: 0.2,
                        messages: [
                            {
                                role: "user",
                                content: content
                            }
                        ]
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error?.message || `Erreur ${response.status}`;
                    } catch {
                        errorMessage = `Erreur ${response.status}: ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                console.error("Erreur API:", error);
                // Si l'erreur est liée à CORS, afficher un message spécifique
                if (error.message.includes("CORS") || error.message.includes("Fetch API cannot load")) {
                    throw new Error("Erreur CORS: Votre navigateur bloque la requête vers l'API Claude. Essayez d'installer une extension CORS Unblock ou utilisez un serveur proxy.");
                }
                throw error;
            }
        }
        
        // Fonction pour créer une synthèse finale après analyse par lots
        async function createFinalSynthesis(allAnalyses, fileName) {
            const content = [
                {
                    type: "text",
                    text: `J'ai analysé le PDF "${fileName}" en plusieurs lots et j'ai obtenu les analyses partielles suivantes. Veuillez créer une synthèse complète qui regroupe toutes les observations par catégorie, élimine les doublons et présente un résumé cohérent.\n\nVoici les analyses partielles:\n\n${allAnalyses}`
                }
            ];
            
            // Appel à l'API Claude
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey.value.trim(),
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: "claude-3-opus-20240229",
                    max_tokens: 4000,
                    temperature: 0.2,
                    messages: [
                        {
                            role: "user",
                            content: content
                        }
                    ]
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Erreur API Claude (${response.status}): ${errorData.error?.message || JSON.stringify(errorData)}`);
            }
            
            const data = await response.json();
            return data.content[0].text;
        }
    </script>
</body>
</html>